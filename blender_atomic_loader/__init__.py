default_colour = (0.0129016, 0.0129016, 0.0129016, 1)
default_diameter = 0.25
default_bond_cutoff = 1.7

default_properties = {
    "H": {"colour": (1.0, 1.0, 1.0, 1.0), "diameter": 0.1652},
"He": {"colour": (0.8509803921568627, 1.0, 1.0, 1.0), "diameter": 0.2048},
"Li": {"colour": (0.8, 0.5019607843137255, 1.0, 1.0), "diameter": 0.9580},
"Be": {"colour": (0.7607843137254902, 1.0, 0.0, 1.0), "diameter": 0.6938},
"B": {"colour": (1.0, 0.7098039215686275, 0.7098039215686275, 1.0), "diameter": 0.5616},
"C": {"colour": (0.367, 0.367, 0.367, 1.0), "diameter": 0.4625},
"N": {"colour": (0.18823529411764706, 0.3137254901960784, 0.9725490196078431, 1.0), "diameter": 0.4295},
"O": {"colour": (1.0, 0.050980392156862744, 0.050980392156862744, 1.0), "diameter": 0.3964},
"F": {"colour": (0.5647058823529412, 0.8784313725490196, 0.3137254901960784, 1.0), "diameter": 0.3304},
"Ne": {"colour": (0.7019607843137254, 0.8901960784313725, 0.9607843137254902, 1.0), "diameter": 0.2511},
"Na": {"colour": (0.6705882352941176, 0.3607843137254902, 0.9490196078431372, 1.0), "diameter": 1.1893},
"Mg": {"colour": (0.5411764705882353, 1.0, 0.0, 1.0), "diameter": 0.9911},
"Al": {"colour": (0.7490196078431373, 0.6509803921568628, 0.6509803921568628, 1.0), "diameter": 0.8259},
"Si": {"colour": (0.9411764705882353, 0.7843137254901961, 0.6274509803921569, 1.0), "diameter": 0.7268},
"P": {"colour": (1.0, 0.5019607843137255, 0.0, 1.0), "diameter": 0.6607},
"S": {"colour": (1.0, 1.0, 0.18823529411764706, 1.0), "diameter": 0.6607},
"Cl": {"colour": (0.12156862745098039, 0.9411764705882353, 0.12156862745098039, 1.0), "diameter": 0.6607},
"Ar": {"colour": (0.5019607843137255, 0.8196078431372549, 0.8901960784313725, 1.0), "diameter": 0.4691},
"K": {"colour": (0.5607843137254902, 0.25098039215686274, 0.8313725490196079, 1.0), "diameter": 1.4536},
"Ca": {"colour": (0.23921568627450981, 1.0, 0.0, 1.0), "diameter": 1.1893},
"Sc": {"colour": (0.9019607843137255, 0.9019607843137255, 0.9019607843137255, 1.0), "diameter": 1.0571},
"Ti": {"colour": (0.7490196078431373, 0.7607843137254902, 0.7803921568627451, 1.0), "diameter": 0.9250},
"V": {"colour": (0.6509803921568628, 0.6509803921568628, 0.6705882352941176, 1.0), "diameter": 0.8920},
"Cr": {"colour": (0.5411764705882353, 0.6, 0.7803921568627451, 1.0), "diameter": 0.9250},
"Mn": {"colour": (0.611764705882353, 0.47843137254901963, 0.7803921568627451, 1.0), "diameter": 0.9250},
"Fe": {"colour": (0.8784313725490196, 0.4, 0.2, 1.0), "diameter": 0.9250},
"Co": {"colour": (0.9411764705882353, 0.5647058823529412, 0.6274509803921569, 1.0), "diameter": 0.8920},
"Ni": {"colour": (0.3137254901960784, 0.8156862745098039, 0.3137254901960784, 1.0), "diameter": 0.8920},
"Cu": {"colour": (0.7843137254901961, 0.5019607843137255, 0.2, 1.0), "diameter": 0.8920},
"Zn": {"colour": (0.49019607843137253, 0.5019607843137255, 0.6901960784313725, 1.0), "diameter": 0.8920},
"Ga": {"colour": (0.7607843137254902, 0.5607843137254902, 0.5607843137254902, 1.0), "diameter": 0.8589},
"Ge": {"colour": (0.4, 0.5607843137254902, 0.5607843137254902, 1.0), "diameter": 0.8259},
"As": {"colour": (0.7411764705882353, 0.5019607843137255, 0.8901960784313725, 1.0), "diameter": 0.7598},
"Se": {"colour": (1.0, 0.6313725490196078, 0.0, 1.0), "diameter": 0.7598},
"Br": {"colour": (0.6509803921568628, 0.1607843137254902, 0.1607843137254902, 1.0), "diameter": 0.7598},
"Kr": {"colour": (0.3607843137254902, 0.7215686274509804, 0.8196078431372549, 1.0), "diameter": 0.5814},
"Rb": {"colour": (0.4392156862745098, 0.1803921568627451, 0.6901960784313725, 1.0), "diameter": 1.5527},
"Sr": {"colour": (0.0, 1.0, 0.0, 1.0), "diameter": 1.3214},
"Y": {"colour": (0.5803921568627451, 1.0, 1.0, 1.0), "diameter": 1.2223},
"Zr": {"colour": (0.5803921568627451, 0.8784313725490196, 0.8784313725490196, 1.0), "diameter": 1.0241},
"Nb": {"colour": (0.45098039215686275, 0.7607843137254902, 0.788235294117647, 1.0), "diameter": 0.9580},
"Mo": {"colour": (0.32941176470588235, 0.7098039215686275, 0.7098039215686275, 1.0), "diameter": 0.9580},
"Tc": {"colour": (0.23137254901960785, 0.6196078431372549, 0.6196078431372549, 1.0), "diameter": 0.8920},
"Ru": {"colour": (0.1411764705882353, 0.5607843137254902, 0.5607843137254902, 1.0), "diameter": 0.8589},
"Rh": {"colour": (0.0392156862745098, 0.49019607843137253, 0.5490196078431373, 1.0), "diameter": 0.8920},
"Pd": {"colour": (0.0, 0.4117647058823529, 0.5215686274509804, 1.0), "diameter": 0.9250},
"Ag": {"colour": (0.7529411764705882, 0.7529411764705882, 0.7529411764705882, 1.0), "diameter": 1.0571},
"Cd": {"colour": (1.0, 0.8509803921568627, 0.5607843137254902, 1.0), "diameter": 1.0241},
"In": {"colour": (0.6509803921568628, 0.4588235294117647, 0.45098039215686275, 1.0), "diameter": 1.0241},
"Sn": {"colour": (0.4, 0.5019607843137255, 0.5019607843137255, 1.0), "diameter": 0.9580},
"Sb": {"colour": (0.6196078431372549, 0.38823529411764707, 0.7098039215686275, 1.0), "diameter": 0.9580},
"Te": {"colour": (0.8313725490196079, 0.47843137254901963, 0.0, 1.0), "diameter": 0.9250},
"I": {"colour": (0.5803921568627451, 0.0, 0.5803921568627451, 1.0), "diameter": 0.9250},
"Xe": {"colour": (0.25882352941176473, 0.6196078431372549, 0.6901960784313725, 1.0), "diameter": 0.7136},
"Cs": {"colour": (0.3411764705882353, 0.09019607843137255, 0.5607843137254902, 1.0), "diameter": 1.7179},
"Ba": {"colour": (0.0, 0.788235294117647, 0.0, 1.0), "diameter": 1.4205},
"La": {"colour": (0.4392156862745098, 0.8313725490196079, 1.0, 1.0), "diameter": 1.2884},
"Ce": {"colour": (1.0, 1.0, 0.7803921568627451, 1.0), "diameter": 1.2223},
"Pr": {"colour": (0.8509803921568627, 1.0, 0.7803921568627451, 1.0), "diameter": 1.2223},
"Nd": {"colour": (0.7803921568627451, 1.0, 0.7803921568627451, 1.0), "diameter": 1.2223},
"Pm": {"colour": (0.6392156862745098, 1.0, 0.7803921568627451, 1.0), "diameter": 1.2223},
"Sm": {"colour": (0.5607843137254902, 1.0, 0.7803921568627451, 1.0), "diameter": 1.2223},
"Eu": {"colour": (0.3803921568627451, 1.0, 0.7803921568627451, 1.0), "diameter": 1.2223},
"Gd": {"colour": (0.27058823529411763, 1.0, 0.7803921568627451, 1.0), "diameter": 1.1893},
"Tb": {"colour": (0.18823529411764706, 1.0, 0.7803921568627451, 1.0), "diameter": 1.1562},
"Dy": {"colour": (0.12156862745098039, 1.0, 0.7803921568627451, 1.0), "diameter": 1.1562},
"Ho": {"colour": (0.0, 1.0, 0.611764705882353, 1.0), "diameter": 1.1562},
"Er": {"colour": (0.0, 0.9019607843137255, 0.4588235294117647, 1.0), "diameter": 1.1562},
"Tm": {"colour": (0.0, 0.8313725490196079, 0.3215686274509804, 1.0), "diameter": 1.1562},
"Yb": {"colour": (0.0, 0.7490196078431373, 0.2196078431372549, 1.0), "diameter": 1.1562},
"Lu": {"colour": (0.0, 0.6705882352941176, 0.1411764705882353, 1.0), "diameter": 1.1562},
"Hf": {"colour": (0.30196078431372547, 0.7607843137254902, 1.0, 1.0), "diameter": 1.0241},
"Ta": {"colour": (0.30196078431372547, 0.6509803921568628, 1.0, 1.0), "diameter": 0.9580},
"W": {"colour": (0.12941176470588237, 0.5803921568627451, 0.8392156862745098, 1.0), "diameter": 0.8920},
"Re": {"colour": (0.14901960784313725, 0.49019607843137253, 0.6705882352941176, 1.0), "diameter": 0.8920},
"Os": {"colour": (0.14901960784313725, 0.4, 0.5882352941176471, 1.0), "diameter": 0.8589},
"Ir": {"colour": (0.09019607843137255, 0.32941176470588235, 0.5294117647058824, 1.0), "diameter": 0.8920},
"Pt": {"colour": (0.8156862745098039, 0.8156862745098039, 0.8784313725490196, 1.0), "diameter": 0.8920},
"Au": {"colour": (1.0, 0.8196078431372549, 0.13725490196078433, 1.0), "diameter": 0.8920},
"Hg": {"colour": (0.7215686274509804, 0.7215686274509804, 0.8156862745098039, 1.0), "diameter": 0.9911},
"Tl": {"colour": (0.6509803921568628, 0.32941176470588235, 0.30196078431372547, 1.0), "diameter": 1.2554},
"Pb": {"colour": (0.3411764705882353, 0.34901960784313724, 0.3803921568627451, 1.0), "diameter": 1.1893},
"Bi": {"colour": (0.6196078431372549, 0.30980392156862746, 0.7098039215686275, 1.0), "diameter": 1.0571},
"Po": {"colour": (0.6705882352941176, 0.3607843137254902, 0.0, 1.0), "diameter": 1.2554},
"At": {"colour": (0.4588235294117647, 0.30980392156862746, 0.27058823529411763, 1.0), "diameter": 0.8391},
"Rn": {"colour": (0.25882352941176473, 0.5098039215686274, 0.5882352941176471, 1.0), "diameter": 0.7929},
"Fr": {"colour": (0.25882352941176473, 0.0, 0.4, 1.0), "diameter": 1.1562},
"Ra": {"colour": (0.0, 0.49019607843137253, 0.0, 1.0), "diameter": 1.1562},
"Ac": {"colour": (0.4392156862745098, 0.6705882352941176, 0.9803921568627451, 1.0), "diameter": 1.2884},
"Th": {"colour": (0.0, 0.7294117647058823, 1.0, 1.0), "diameter": 1.1893},
"Pa": {"colour": (0.0, 0.6313725490196078, 1.0, 1.0), "diameter": 1.1893},
"U": {"colour": (0.0, 0.5607843137254902, 1.0, 1.0), "diameter": 1.1562},
"Np": {"colour": (0.0, 0.5019607843137255, 1.0, 1.0), "diameter": 1.1562},
"Pu": {"colour": (0.0, 0.4196078431372549, 1.0, 1.0), "diameter": 1.1562},
"Am": {"colour": (0.32941176470588235, 0.3607843137254902, 0.9490196078431372, 1.0), "diameter": 1.1562},
"Cm": {"colour": (0.47058823529411764, 0.3607843137254902, 0.8901960784313725, 1.0), "diameter": 1.1562},
"Bk": {"colour": (0.5411764705882353, 0.30980392156862746, 0.8901960784313725, 1.0), "diameter": 1.1562},
"Cf": {"colour": (0.6313725490196078, 0.21176470588235294, 0.8313725490196079, 1.0), "diameter": 1.1562},
"Es": {"colour": (0.7019607843137254, 0.12156862745098039, 0.8313725490196079, 1.0), "diameter": 1.1562},
"Fm": {"colour": (0.7019607843137254, 0.12156862745098039, 0.7294117647058823, 1.0), "diameter": 1.1562},
"Md": {"colour": (0.7019607843137254, 0.050980392156862744, 0.6509803921568628, 1.0), "diameter": 1.1562},
"No": {"colour": (0.7411764705882353, 0.050980392156862744, 0.5294117647058824, 1.0), "diameter": 1.1562},
"Lr": {"colour": (0.7803921568627451, 0.0, 0.4, 1.0), "diameter": 1.1562},
"Rf": {"colour": (0.8, 0.0, 0.34901960784313724, 1.0), "diameter": 1.1562},
"Db": {"colour": (0.8196078431372549, 0.0, 0.30980392156862746, 1.0), "diameter": 1.1562},
"Sg": {"colour": (0.8509803921568627, 0.0, 0.27058823529411763, 1.0), "diameter": 1.1562},
"Bh": {"colour": (0.8784313725490196, 0.0, 0.2196078431372549, 1.0), "diameter": 1.1562},
"Hs": {"colour": (0.9019607843137255, 0.0, 0.1803921568627451, 1.0), "diameter": 1.1562},
"Mt": {"colour": (0.9215686274509803, 0.0, 0.14901960784313725, 1.0), "diameter": 1.1562}
}


def create_basic_material(mat_name='C', colour=default_properties['C']["colour"]):
    import bpy
    import bmesh
    import mathutils
        
    # Switch to Cycles 
    bpy.context.scene.render.engine = 'CYCLES'
    
    # check whether the material already exists
    if bpy.data.materials.get(mat_name):
        mat = bpy.data.materials[mat_name]
    else:
        # create the material
        mat = bpy.data.materials.new(mat_name)
        mat.diffuse_color = colour # viewport color RGBA
        mat.use_nodes = True
    
        # get the material nodes
        nodes = mat.node_tree.nodes
        
        # clear all nodes to start clean
        for node in nodes:
            nodes.remove(node)
        
        # create glossy node
        node_glossy = nodes.new(type='ShaderNodeBsdfGlossy')
        node_glossy.inputs[0].default_value = (1,1,1,1)  # RGBA
        node_glossy.inputs[1].default_value = 0.223 # roughness
        node_glossy.location = -200,100
        
        # create diffuse node
        node_diffuse = nodes.new(type='ShaderNodeBsdfDiffuse')
        node_diffuse.inputs[0].default_value = colour  # RGBA
        node_diffuse.inputs[1].default_value = 0.202 # roughness
        node_diffuse.location = -200,-100
        
        # create mix shader node
        node_mix = nodes.new(type='ShaderNodeMixShader')
        node_mix.inputs[0].default_value = 0.925
        node_mix.location = 0,0
        
        # create output node
        node_output = nodes.new(type='ShaderNodeOutputMaterial')   
        node_output.location = 200,0
        
        # link nodes
        links = mat.node_tree.links
        link_diff_mix = links.new(node_diffuse.outputs[0], node_mix.inputs[2])
        link_gloss_mix = links.new(node_glossy.outputs[0], node_mix.inputs[1])
        
        # link mix to output node
        link_mix_out = links.new(node_mix.outputs[0], node_output.inputs[0])
    
    return mat

def create_sphere(pos=[0,0,0], diameter=default_diameter, label="Atom", mat_name="BasicMaterial", colour=default_colour):
    import bpy
    import bmesh
    import mathutils
    
    # Create an empty mesh and the object.
    mesh = bpy.data.meshes.new(label)
    basic_sphere = bpy.data.objects.new(label, mesh)
    
    # Add the object into the scene.
    bpy.context.collection.objects.link(basic_sphere)
    
    # Select the newly created object
    bpy.context.view_layer.objects.active = basic_sphere
    basic_sphere.select_set(True)
    
    # Construct the bmesh sphere and assign it to the blender mesh.
    bm = bmesh.new()

    # create a location matrix
    mat_loc = mathutils.Matrix.Translation(pos)
    bmesh.ops.create_uvsphere(bm, u_segments=18, v_segments=16, diameter=diameter, matrix=mat_loc)
    bm.to_mesh(mesh)
    bm.free()
    
    # smooth the surface
    bpy.ops.object.modifier_add(type='SUBSURF')
    bpy.ops.object.shade_smooth()

    # put the origin to the geometry
    bpy.ops.object.origin_set(type='ORIGIN_GEOMETRY', center='MEDIAN')

    # move the obeject to a collection
    # bpy.ops.object.move_to_collection(collection_index=0, is_new=True, new_collection_name=atom_name)
    
    ### Refine the material
    mat = create_basic_material(mat_name=label, colour=colour)
    
    # Assign it to the context object
    obj = bpy.context.active_object
    
    if obj.data.materials:
        # assign to 1st material slot
        obj.data.materials[0] = mat
    else:
        # no slots
        obj.data.materials.append(mat)
    
    
def cylinder_between(point1, point2, diameter=default_diameter, label="Bond", mat_name="Material", colour=default_colour):
      
    import math
    import bpy
    import bmesh
    
    
    x1=point1[0]
    y1=point1[1]
    z1=point1[2]
    x2=point2[0]
    y2=point2[1]
    z2=point2[2]
    
    dx = x2 - x1
    dy = y2 - y1
    dz = z2 - z1    
    dist = math.sqrt(dx**2 + dy**2 + dz**2)
    
    bpy.ops.mesh.primitive_cylinder_add(
        vertices = 32, 
        radius = diameter,
        depth = dist,
        location = (dx/2 + x1, dy/2 + y1, dz/2 + z1)   
    ) 
    
    phi = math.atan2(dy, dx) 
    theta = math.acos(dz/dist) 
    
    bpy.context.object.rotation_euler[1] = theta 
    bpy.context.object.rotation_euler[2] = phi 
        
    # smooth the surface
    #bpy.ops.object.modifier_add(type='SUBSURF')
    bpy.ops.object.shade_smooth()

    # put the origin to the geometry
    bpy.ops.object.origin_set(type='ORIGIN_GEOMETRY', center='MEDIAN')

    ### Refine the material
    mat = create_basic_material(mat_name=mat_name, colour=colour)
    
    # Assign it to the context object
    obj = bpy.context.active_object

    # Rename the object
    obj.name = label
    
    if obj.data.materials:
        # assign to 1st material slot
        obj.data.materials[0] = mat
    else:
        # no slots
        obj.data.materials.append(mat)


def get_molecule(aseframe):
    import numpy as np
    
    mol=aseframe[np.where(np.asarray(aseframe.get_chemical_symbols())!='Au')[0]]
    # check for possible H passivating gold, far from the molecule
    # first get the z-coordinate of center of mass of the carbon backbone
    cmass_mol=int(mol[np.where(np.asarray(mol.get_chemical_symbols())=='C')[0]].get_center_of_mass()[2])
    # get hydrogens z-coordinate and cast it to an integer 
    # (to round up layers and get rid of fluctuations)
    id_hydrogens=np.where(np.asarray(mol.get_chemical_symbols())=='H')[0]
    hydrogens_z=np.asarray(list(map(int,mol[id_hydrogens].positions[:,2])))
    # discard the hydrogens far away
    id_mol=np.asarray([i for i,at in enumerate(mol) if i not in id_hydrogens[np.where(np.abs(hydrogens_z-cmass_mol)>3)[0]]])
    return mol[id_mol]

def get_substrate(aseframe):
    import numpy as np
    return aseframe[np.where(np.asarray(aseframe.get_chemical_symbols())=='Au')[0]]

def get_neighbours(aseframe):
    # get the neighbours of each atom in the molecule
    from scipy.spatial import cKDTree
    # get the kd-tree for nearest neighbors
    kdtree=cKDTree(aseframe.positions)
    neigh_list={}
    for i,pos in enumerate(aseframe.positions):
        # Query the kd-tree and get the first 7 neighbours
        _,neighs=kdtree.query(pos,k=8)
        # exclude the 1st element (the point itself)
        neigh_list[i]=neighs[1:]
    return neigh_list

def get_bonds(aseframe,cutoff=default_bond_cutoff):
    import numpy as np
    # get the bonds list
    
    # get the distance matrix
    dist_mat=aseframe.get_all_distances()
    bond_list=[]
    for i,dists in enumerate(dist_mat):
        bond_list.append([np.sort([i,j]) for j in np.where(dists<cutoff)[0] if i!=j])
    # returne the list of unique bonds
    bond_list = [x for x in bond_list if x != []]
    if bond_list == []:
        bond_list = [[]]
    return np.asarray(list(set([tuple(i) for i in np.concatenate(bond_list)])))

def split_bonds(aseframe,cutoff=default_bond_cutoff):
    import numpy as np
    # split the bonds with hydrogens from those without
    tot_bonds=get_bonds(aseframe,cutoff)
    # find all the bonds with hydrogens
    ll=[]
    for bond_atoms in tot_bonds:
        atom_types=[aseframe[j].symbol for j in bond_atoms]
        ll.append('H' in atom_types)
    ll=np.asarray(ll)
    id_hbonds=np.where(ll==True)[0]
    id_nohbonds=np.where(ll==False)[0]
    return tot_bonds[id_hbonds],tot_bonds[id_nohbonds]

def draw_atoms(aseframe, atom_type):
    import numpy as np
    # draw spheres for a specific atom type
    for pos in aseframe[np.where(np.asarray(aseframe.get_chemical_symbols())==atom_type)[0]].positions:
        create_sphere(pos=pos, 
                      diameter=default_properties[atom_type]["diameter"], 
                      label=atom_type, 
                      mat_name=atom_type, 
                      colour=default_properties[atom_type]["colour"]
                      )
        
def draw_molecule(aseframe):
    import numpy as np
    
    # get the set of atomic types
    atom_types = list(set(aseframe.get_chemical_symbols()))
    
    # loop through the species and draw the spheres
    for atom_type in atom_types:
        draw_atoms(aseframe, atom_type)
        
    # Get the bonds and split those involving hydrogens
    b_hydr,b_backb = split_bonds(aseframe)    
    
    # Draw the the backbone bonds of the molecule
    for bond in b_backb:
        # we need to pass to the function the coordinates of the two ends
        # use 0.52 the diamter of a carbon and the same material as carbon atoms
        cylinder_between(aseframe[bond[0]].position, 
                         aseframe[bond[1]].position, 
                         diameter=default_properties["C"]["diameter"]*0.52,
                         label=aseframe[bond[0]].symbol+"-"+aseframe[bond[1]].symbol+"-bond",
                         mat_name="C")
        
        
    # Draw the the bonds with hydrogens
    for bond in b_hydr:
        # we need to pass to the function the coordinates of the two ends
        # use 0.7 the diamter of a hydrogen and the same material as hydrogen atoms
        cylinder_between(aseframe[bond[0]].position,
                         aseframe[bond[1]].position, 
                         diameter=default_properties["H"]["diameter"]*0.7, 
                         label=aseframe[bond[0]].symbol+"-"+aseframe[bond[1]].symbol+"-bond",
                         mat_name="H")
